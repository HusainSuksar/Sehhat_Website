{% extends 'base.html' %}
{% block title %}Object Permission Management{% endblock %}
{% block content %}
<div class="container-fluid px-2 px-md-4">
    <h1 class="h3 mb-4">Object Permission Management</h1>
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="id_user" class="form-label">User</label>
                        {{ form.user }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_model" class="form-label">Model</label>
                        {{ form.model }}
                    </div>
                    <div class="col-md-3">
                        <label for="id_object_id" class="form-label">Object</label>
                        {{ form.object_id }}
                        <div class="form-text">Select a model first to see available objects</div>
                    </div>
                    <div class="col-md-3">
                        <label for="id_permission" class="form-label">Permission</label>
                        {{ form.permission }}
                        <div class="form-text">Select a model first to see available permissions</div>
                    </div>
                    <div class="col-md-2">
                        <label for="id_action" class="form-label">Action</label>
                        {{ form.action }}
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success">Apply Permission</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetForm()">Reset</button>
                    </div>
                </div>
            </form>
            {% if result %}
            <div class="alert alert-info mt-3">{{ result }}</div>
            {% endif %}
        </div>
    </div>
    <div class="alert alert-warning">
        <strong>Note:</strong> This interface allows you to assign or remove object-level permissions. 
        Select a user, model, object, and permission, then choose to assign or remove it.
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('id_model');
    const objectSelect = document.getElementById('id_object_id');
    const permissionSelect = document.getElementById('id_permission');
    
    // Get CSRF token
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Handle model selection change
    modelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        if (selectedModel) {
            loadObjects(selectedModel);
            loadPermissions(selectedModel);
        } else {
            clearDropdowns();
        }
    });
    
    function loadObjects(modelName) {
        const csrfToken = getCSRFToken();
        fetch(`?action=get_objects&model=${modelName}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            objectSelect.innerHTML = '<option value="">Select an object...</option>';
            if (data.objects && data.objects.length > 0) {
                data.objects.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[0];
                    option.textContent = item[1];
                    objectSelect.appendChild(option);
                });
            } else {
                objectSelect.innerHTML = '<option value="">No objects found</option>';
            }
        })
        .catch(error => {
            console.error('Error loading objects:', error);
            objectSelect.innerHTML = '<option value="">Error loading objects</option>';
        });
    }
    
    function loadPermissions(modelName) {
        const csrfToken = getCSRFToken();
        fetch(`?action=get_permissions&model=${modelName}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            permissionSelect.innerHTML = '<option value="">Select a permission...</option>';
            if (data.permissions && data.permissions.length > 0) {
                data.permissions.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[0];
                    option.textContent = item[1];
                    permissionSelect.appendChild(option);
                });
            } else {
                permissionSelect.innerHTML = '<option value="">No permissions found</option>';
            }
        })
        .catch(error => {
            console.error('Error loading permissions:', error);
            permissionSelect.innerHTML = '<option value="">Error loading permissions</option>';
        });
    }
    
    function clearDropdowns() {
        objectSelect.innerHTML = '<option value="">Select a model first...</option>';
        permissionSelect.innerHTML = '<option value="">Select a model first...</option>';
    }
});

function resetForm() {
    document.getElementById('id_user').value = '';
    document.getElementById('id_model').value = '';
    document.getElementById('id_object_id').innerHTML = '<option value="">Select a model first...</option>';
    document.getElementById('id_permission').innerHTML = '<option value="">Select a model first...</option>';
    document.getElementById('id_action').value = '';
}
</script>
{% endblock %}