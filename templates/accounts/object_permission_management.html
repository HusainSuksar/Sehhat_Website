{% extends 'base.html' %}
{% block title %}Object Permission Management{% endblock %}
{% block content %}
<div class="container-fluid px-2 px-md-4">
    <h1 class="h3 mb-4">Object Permission Management</h1>
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="id_user" class="form-label">User</label>
                        {{ form.user }}
                    </div>
                    <div class="col-md-2">
                        <label for="id_model" class="form-label">Model</label>
                        {{ form.model }}
                    </div>
                    <div class="col-md-3">
                        <label for="id_object_id" class="form-label">Object</label>
                        {{ form.object_id }}
                        <div class="form-text">Select a model first to see available objects</div>
                    </div>
                    <div class="col-md-3">
                        <label for="id_permission" class="form-label">Permission</label>
                        {{ form.permission }}
                        <div class="form-text">Select a model first to see available permissions</div>
                    </div>
                    <div class="col-md-2">
                        <label for="id_action" class="form-label">Action</label>
                        {{ form.action }}
                    </div>
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-success">Apply Permission</button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="resetForm()">Reset</button>
                    </div>
                </div>
            </form>
            {% if result %}
            <div class="alert alert-info mt-3">{{ result }}</div>
            {% endif %}
        </div>
    </div>
    <div class="alert alert-warning">
        <strong>Note:</strong> This interface allows you to assign or remove object-level permissions. 
        Select a user, model, object, and permission, then choose to assign or remove it.
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('id_user');
    const modelSelect = document.getElementById('id_model');
    const objectSelect = document.getElementById('id_object_id');
    const permissionSelect = document.getElementById('id_permission');

    // When user is selected, fetch models and objects
    userSelect.addEventListener('change', function() {
        const userId = this.value;
        if (userId) {
            fetch(`?action=get_user_objects&user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    // Populate model dropdown
                    modelSelect.innerHTML = '';
                    data.models.forEach(function(model) {
                        const option = document.createElement('option');
                        option.value = model[0];
                        option.textContent = model[1];
                        modelSelect.appendChild(option);
                    });
                    // If only one model, select it
                    if (data.models.length === 1) {
                        modelSelect.value = data.models[0][0];
                    }
                    // Populate object dropdown for first model
                    const firstModel = data.models[0][0];
                    objectSelect.innerHTML = '';
                    data.objects_by_model[firstModel].forEach(function(obj) {
                        const option = document.createElement('option');
                        option.value = obj[0];
                        option.textContent = obj[1];
                        objectSelect.appendChild(option);
                    });
                    // If only one object, select it
                    if (data.objects_by_model[firstModel].length === 1) {
                        objectSelect.value = data.objects_by_model[firstModel][0][0];
                    }
                    // Trigger permission load for first model
                    loadPermissions(firstModel);
                });
        } else {
            clearDropdowns();
        }
    });

    // When model is changed, update objects and permissions
    modelSelect.addEventListener('change', function() {
        const selectedModel = this.value;
        const userId = userSelect.value;
        if (selectedModel && userId) {
            fetch(`?action=get_user_objects&user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    objectSelect.innerHTML = '';
                    data.objects_by_model[selectedModel].forEach(function(obj) {
                        const option = document.createElement('option');
                        option.value = obj[0];
                        option.textContent = obj[1];
                        objectSelect.appendChild(option);
                    });
                    if (data.objects_by_model[selectedModel].length === 1) {
                        objectSelect.value = data.objects_by_model[selectedModel][0][0];
                    }
                });
            loadPermissions(selectedModel);
        } else {
            clearDropdowns();
        }
    });

    function loadPermissions(modelName) {
        fetch(`?action=get_permissions&model=${modelName}`)
            .then(response => response.json())
            .then(data => {
                permissionSelect.innerHTML = '<option value="">Select a permission...</option>';
                data.permissions.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[0];
                    option.textContent = item[1];
                    permissionSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading permissions:', error);
                permissionSelect.innerHTML = '<option value="">Error loading permissions</option>';
            });
    }

    function clearDropdowns() {
        modelSelect.innerHTML = '<option value="">Select a user first...</option>';
        objectSelect.innerHTML = '<option value="">Select a model first...</option>';
        permissionSelect.innerHTML = '<option value="">Select a model first...</option>';
    }
});

function resetForm() {
    document.getElementById('id_user').value = '';
    document.getElementById('id_model').value = '';
    document.getElementById('id_object_id').innerHTML = '<option value="">Select a model first...</option>';
    document.getElementById('id_permission').innerHTML = '<option value="">Select a model first...</option>';
    document.getElementById('id_action').value = '';
}
</script>
{% endblock %}