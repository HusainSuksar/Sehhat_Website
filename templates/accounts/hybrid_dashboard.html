{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-online { background-color: #28a745; }
    .status-offline { background-color: #dc3545; }
    .api-status {
        font-size: 0.9em;
        color: #6c757d;
    }
    .hybrid-section {
        margin-bottom: 30px;
    }
    .data-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    @media (max-width: 768px) {
        .data-comparison {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> {{ page_title }}</h1>
            <p class="text-muted">Dashboard showing data from both local database and external API sources</p>
        </div>
    </div>

    <!-- API Status Section -->
    <div class="row">
        <div class="col-12">
            <div class="stats-card">
                <div class="stats-header">
                    <h3><i class="fas fa-server"></i> System Status</h3>
                    <div class="api-status">
                        <span class="status-indicator {% if system_status.api_status.is_available %}status-online{% else %}status-offline{% endif %}"></span>
                        External API: {% if system_status.api_status.is_available %}Online{% else %}Offline{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Database:</strong> {{ system_status.database_status|title }}
                    </div>
                    <div class="col-md-3">
                        <strong>Cache:</strong> {{ system_status.cache_status|title }}
                    </div>
                    <div class="col-md-6">
                        <strong>API URL:</strong> 
                        <code>{{ system_status.api_status.base_url }}</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Comparison -->
    <div class="row">
        <div class="col-12">
            <div class="hybrid-section">
                <h2><i class="fas fa-analytics"></i> Data Statistics Comparison</h2>
                
                <div class="data-comparison">
                    <!-- Local Data -->
                    <div class="stats-card">
                        <h4><i class="fas fa-database"></i> Local Database</h4>
                        <ul class="list-unstyled">
                            <li><strong>Users:</strong> {{ local_stats.users }}</li>
                            <li><strong>Students:</strong> {{ local_stats.students }}</li>
                            <li><strong>Doctors:</strong> {{ local_stats.doctors }}</li>
                            <li><strong>Hospitals:</strong> {{ local_stats.hospitals }}</li>
                            <li><strong>Patients:</strong> {{ local_stats.patients }}</li>
                            <li><strong>Surveys:</strong> {{ local_stats.surveys }}</li>
                            <li><strong>Evaluations:</strong> {{ local_stats.evaluation_forms }}</li>
                            <li><strong>Petitions:</strong> {{ local_stats.petitions }}</li>
                            <li><strong>Moze Centers:</strong> {{ local_stats.moze_centers }}</li>
                            <li><strong>Photo Albums:</strong> {{ local_stats.photo_albums }}</li>
                        </ul>
                    </div>

                    <!-- External Data -->
                    <div class="stats-card">
                        <h4><i class="fas fa-cloud"></i> External API</h4>
                        {% if external_available %}
                            <ul class="list-unstyled">
                                <li><strong>Users:</strong> {{ external_stats.users|default:"0" }}</li>
                                <li><strong>Students:</strong> {{ external_stats.students|default:"0" }}</li>
                                <li><strong>Doctors:</strong> {{ external_stats.doctors|default:"0" }}</li>
                                <li><strong>Hospitals:</strong> {{ external_stats.hospitals|default:"0" }}</li>
                                <li><strong>Patients:</strong> {{ external_stats.patients|default:"0" }}</li>
                                <li><strong>Surveys:</strong> {{ external_stats.surveys|default:"0" }}</li>
                                <li><strong>Evaluations:</strong> {{ external_stats.evaluation_forms|default:"0" }}</li>
                                <li><strong>Petitions:</strong> {{ external_stats.petitions|default:"0" }}</li>
                                <li><strong>Moze Centers:</strong> {{ external_stats.moze_centers|default:"0" }}</li>
                                <li><strong>Photo Albums:</strong> {{ external_stats.photo_albums|default:"0" }}</li>
                            </ul>
                        {% else %}
                            <div class="text-muted">
                                <i class="fas fa-exclamation-triangle"></i> 
                                External API unavailable
                                {% if external_error %}
                                <br><small>{{ external_error }}</small>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Combined Data -->
                    <div class="stats-card">
                        <h4><i class="fas fa-layer-group"></i> Combined Total</h4>
                        <ul class="list-unstyled">
                            <li><strong>Total Users:</strong> {{ combined_stats.total_users }}</li>
                            <li><strong>Total Doctors:</strong> {{ combined_stats.total_doctors }}</li>
                            <li><strong>Total Hospitals:</strong> {{ combined_stats.total_hospitals }}</li>
                            <li><strong>Total Surveys:</strong> {{ combined_stats.total_surveys }}</li>
                            <li><strong>Total Evaluations:</strong> {{ combined_stats.total_evaluation_forms }}</li>
                        </ul>
                        
                        {% if user.is_staff %}
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshCache()">
                                <i class="fas fa-sync-alt"></i> Refresh Cache
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links to Hybrid Views -->
    <div class="row">
        <div class="col-12">
            <div class="stats-card">
                <h3><i class="fas fa-link"></i> Hybrid Data Views</h3>
                <p class="text-muted">Access views that combine local and external data</p>
                
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'accounts_api:hybrid_doctors' %}" class="btn btn-outline-primary btn-block">
                            <i class="fas fa-user-md"></i> All Doctors
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'accounts_api:hybrid_hospitals' %}" class="btn btn-outline-success btn-block">
                            <i class="fas fa-hospital"></i> All Hospitals
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'accounts_api:hybrid_surveys' %}" class="btn btn-outline-info btn-block">
                            <i class="fas fa-poll"></i> All Surveys
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'accounts_api:api_configuration' %}" class="btn btn-outline-warning btn-block">
                            <i class="fas fa-cog"></i> API Config
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function refreshCache() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    button.disabled = true;
    
    try {
        const response = await fetch('{% url "accounts_api:api_refresh_cache" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Cache refreshed successfully!');
            location.reload();
        } else {
            alert('Error refreshing cache: ' + result.error);
        }
    } catch (error) {
        alert('Error refreshing cache: ' + error.message);
    }
    
    button.innerHTML = originalText;
    button.disabled = false;
}

// Auto-refresh system status every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('{% url "accounts_api:api_system_status" %}');
        const status = await response.json();
        
        const indicator = document.querySelector('.status-indicator');
        const statusText = indicator.parentElement;
        
        if (status.api_available) {
            indicator.className = 'status-indicator status-online';
            statusText.innerHTML = statusText.innerHTML.replace(/Online|Offline/, 'Online');
        } else {
            indicator.className = 'status-indicator status-offline';
            statusText.innerHTML = statusText.innerHTML.replace(/Online|Offline/, 'Offline');
        }
    } catch (error) {
        console.log('Status check failed:', error);
    }
}, 30000);
</script>
{% endblock %}