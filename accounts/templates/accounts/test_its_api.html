<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Mock ITS API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 10px 0;
        }
        .test-section {
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .field-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üîç Mock ITS API Tester</h1>
                <p class="text-center text-muted">Test the Mock ITS API and see real-time results</p>
            </div>
        </div>

        <!-- Test Section 1: Fetch User by ITS ID -->
        <div class="test-section">
            <h3>üì± Test 1: Fetch User by ITS ID</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="itsId" class="form-label">Enter ITS ID (8 digits):</label>
                        <input type="text" class="form-control" id="itsId" placeholder="12345678" maxlength="8">
                        <div class="form-text">Try: 12345678, 87654321, 99999999</div>
                    </div>
                    <button class="btn btn-primary" onclick="fetchUserData()">üîç Fetch User Data</button>
                    <button class="btn btn-secondary ms-2" onclick="generateRandomId()">üé≤ Random ID</button>
                </div>
                <div class="col-md-6">
                    <h5>Quick Test IDs:</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-info btn-sm" onclick="setItsId('12345678')">12345678</button>
                        <button class="btn btn-outline-info btn-sm" onclick="setItsId('87654321')">87654321</button>
                        <button class="btn btn-outline-info btn-sm" onclick="setItsId('99999999')">99999999</button>
                        <button class="btn btn-outline-info btn-sm" onclick="setItsId('11111111')">11111111</button>
                    </div>
                </div>
            </div>
            <div id="userResult" class="mt-3"></div>
        </div>

        <!-- Test Section 2: Search Users -->
        <div class="test-section">
            <h3>üîç Test 2: Search Users</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="searchQuery" class="form-label">Search Query:</label>
                        <input type="text" class="form-control" id="searchQuery" placeholder="Ahmed">
                        <div class="form-text">Try: Ahmed, Ali, Fatima, test</div>
                    </div>
                    <button class="btn btn-success" onclick="searchUsers()">üîç Search Users</button>
                </div>
                <div class="col-md-6">
                    <h5>Quick Searches:</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-success btn-sm" onclick="setSearchQuery('Ahmed')">Ahmed</button>
                        <button class="btn btn-outline-success btn-sm" onclick="setSearchQuery('Ali')">Ali</button>
                        <button class="btn btn-outline-success btn-sm" onclick="setSearchQuery('Fatima')">Fatima</button>
                        <button class="btn btn-outline-success btn-sm" onclick="setSearchQuery('test')">test</button>
                    </div>
                </div>
            </div>
            <div id="searchResult" class="mt-3"></div>
        </div>

        <!-- Test Section 3: Validate ITS ID -->
        <div class="test-section">
            <h3>‚úÖ Test 3: Validate ITS ID</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="validateId" class="form-label">ITS ID to Validate:</label>
                        <input type="text" class="form-control" id="validateId" placeholder="12345678">
                        <div class="form-text">Try invalid: 123, abcd1234, 123456789</div>
                    </div>
                    <button class="btn btn-warning" onclick="validateItsId()">‚úÖ Validate ID</button>
                </div>
                <div class="col-md-6">
                    <h5>Test Cases:</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-warning btn-sm" onclick="setValidateId('12345678')">Valid: 12345678</button>
                        <button class="btn btn-outline-warning btn-sm" onclick="setValidateId('123')">Invalid: 123</button>
                        <button class="btn btn-outline-warning btn-sm" onclick="setValidateId('abcd1234')">Invalid: abcd1234</button>
                    </div>
                </div>
            </div>
            <div id="validateResult" class="mt-3"></div>
        </div>

        <!-- Test Section 4: Create Django User -->
        <div class="test-section">
            <h3>üë§ Test 4: Create Django User from ITS</h3>
            <p class="text-muted">This will fetch ITS data and create a Django User record</p>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="createUserId" class="form-label">ITS ID for User Creation:</label>
                        <input type="text" class="form-control" id="createUserId" placeholder="55555555">
                    </div>
                    <button class="btn btn-info" onclick="createUserFromIts()">üë§ Create User</button>
                </div>
            </div>
            <div id="createResult" class="mt-3"></div>
        </div>
    </div>

    <script>
        // Set CSRF token for Django
        axios.defaults.xsrfHeaderName = "X-CSRFToken";
        axios.defaults.xsrfCookieName = "csrftoken";

        // Helper functions for quick input
        function setItsId(id) {
            document.getElementById('itsId').value = id;
        }

        function setSearchQuery(query) {
            document.getElementById('searchQuery').value = query;
        }

        function setValidateId(id) {
            document.getElementById('validateId').value = id;
        }

        function generateRandomId() {
            const randomId = Math.floor(10000000 + Math.random() * 90000000).toString();
            document.getElementById('itsId').value = randomId;
        }

        // Test 1: Fetch User Data
        async function fetchUserData() {
            const itsId = document.getElementById('itsId').value;
            const resultDiv = document.getElementById('userResult');
            
            if (!itsId) {
                showError(resultDiv, 'Please enter an ITS ID');
                return;
            }

            showLoading(resultDiv, 'Fetching user data...');

            try {
                const response = await axios.post('/accounts/api/test-its/', {
                    action: 'fetch_user',
                    its_id: itsId
                });

                if (response.data.success) {
                    showUserData(resultDiv, response.data.data);
                } else {
                    showError(resultDiv, response.data.error || 'No data found');
                }
            } catch (error) {
                showError(resultDiv, 'Error: ' + error.message);
            }
        }

        // Test 2: Search Users
        async function searchUsers() {
            const query = document.getElementById('searchQuery').value;
            const resultDiv = document.getElementById('searchResult');
            
            if (!query) {
                showError(resultDiv, 'Please enter a search query');
                return;
            }

            showLoading(resultDiv, 'Searching users...');

            try {
                const response = await axios.post('/accounts/api/test-its/', {
                    action: 'search_users',
                    query: query
                });

                if (response.data.success) {
                    showSearchResults(resultDiv, response.data.data);
                } else {
                    showError(resultDiv, response.data.error || 'No results found');
                }
            } catch (error) {
                showError(resultDiv, 'Error: ' + error.message);
            }
        }

        // Test 3: Validate ITS ID
        async function validateItsId() {
            const itsId = document.getElementById('validateId').value;
            const resultDiv = document.getElementById('validateResult');
            
            if (!itsId) {
                showError(resultDiv, 'Please enter an ITS ID to validate');
                return;
            }

            try {
                const response = await axios.post('/accounts/api/test-its/', {
                    action: 'validate_id',
                    its_id: itsId
                });

                showValidationResult(resultDiv, response.data);
            } catch (error) {
                showError(resultDiv, 'Error: ' + error.message);
            }
        }

        // Test 4: Create Django User
        async function createUserFromIts() {
            const itsId = document.getElementById('createUserId').value;
            const resultDiv = document.getElementById('createResult');
            
            if (!itsId) {
                showError(resultDiv, 'Please enter an ITS ID');
                return;
            }

            showLoading(resultDiv, 'Creating Django user...');

            try {
                const response = await axios.post('/accounts/api/test-its/', {
                    action: 'create_user',
                    its_id: itsId
                });

                if (response.data.success) {
                    showUserCreationResult(resultDiv, response.data);
                } else {
                    showError(resultDiv, response.data.error || 'Failed to create user');
                }
            } catch (error) {
                showError(resultDiv, 'Error: ' + error.message);
            }
        }

        // Display functions
        function showLoading(div, message) {
            div.innerHTML = `
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    ${message}
                </div>
            `;
        }

        function showError(div, message) {
            div.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå ${message}
                </div>
            `;
        }

        function showUserData(div, data) {
            const fields = Object.entries(data).map(([key, value]) => 
                `<div class="field-item">
                    <strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value || 'N/A'}
                </div>`
            ).join('');

            div.innerHTML = `
                <div class="result-card p-3">
                    <h5>‚úÖ User Data Retrieved Successfully</h5>
                    <div class="field-grid mt-3">
                        ${fields}
                    </div>
                </div>
            `;
        }

        function showSearchResults(div, results) {
            const resultCards = results.map(user => `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${user.first_name} ${user.last_name}</h6>
                            <p class="card-text">
                                <strong>ITS ID:</strong> ${user.its_id}<br>
                                <strong>Email:</strong> ${user.email}<br>
                                <strong>Organization:</strong> ${user.organization}<br>
                                <strong>City:</strong> ${user.city}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');

            div.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Found ${results.length} results
                </div>
                <div class="row">
                    ${resultCards}
                </div>
            `;
        }

        function showValidationResult(div, data) {
            const isValid = data.valid;
            const alertClass = isValid ? 'alert-success' : 'alert-danger';
            const icon = isValid ? '‚úÖ' : '‚ùå';
            
            div.innerHTML = `
                <div class="alert ${alertClass}">
                    ${icon} ITS ID "${data.its_id}" is ${isValid ? 'VALID' : 'INVALID'}
                    ${data.message ? `<br><small>${data.message}</small>` : ''}
                </div>
            `;
        }

        function showUserCreationResult(div, data) {
            div.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ ${data.created ? 'Created new' : 'Found existing'} Django user
                </div>
                <div class="card">
                    <div class="card-body">
                        <h6>User Details:</h6>
                        <p>
                            <strong>ID:</strong> ${data.user.id}<br>
                            <strong>Name:</strong> ${data.user.first_name} ${data.user.last_name}<br>
                            <strong>Email:</strong> ${data.user.email}<br>
                            <strong>City:</strong> ${data.user.city}<br>
                            <strong>Mobile:</strong> ${data.user.mobile_number}
                        </p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>